{% extends "main/base.html" %}
{% load static %}

{% block title %}{{ project.title }} Dashboard | AI Novel Creator{% endblock %}

{% block content %}
  <section class="card">
    <div class="header-row">
      <h1>{{ project.title }}</h1>
      <div class="actions">
        <a class="btn btn-secondary" href="{% url 'project-detail' slug=project.slug %}">Details</a>
        <a class="btn btn-secondary" href="{% url 'full-novel' slug=project.slug %}">Full novel</a>
        <a class="btn btn-secondary" href="{% url 'character-list' slug=project.slug %}">Characters</a>
        <a class="btn btn-secondary" href="{% url 'location-list' slug=project.slug %}">Locations</a>
        <a class="btn btn-secondary" href="{% url 'project-edit' slug=project.slug %}">Edit</a>
        <a class="btn btn-secondary" href="{% url 'project-list' %}">All projects</a>
      </div>
    </div>

    <dl class="dl">
      <div class="dl-row">
        <dt>Slug</dt>
        <dd>{{ project.slug }}</dd>
      </div>
      <div class="dl-row">
        <dt>Genre</dt>
        <dd>{{ project.genre|default:"-" }}</dd>
      </div>
      <div class="dl-row">
        <dt>Tone</dt>
        <dd>{{ project.tone|default:"-" }}</dd>
      </div>
      <div class="dl-row">
        <dt>Target word count</dt>
        <dd>{{ project.target_word_count }}</dd>
      </div>
      <div class="dl-row">
        <dt>Current word count</dt>
        <dd>{{ current_word_count }}</dd>
      </div>
    </dl>

    <h2 class="h2">Actions</h2>
    <form method="post" class="actions">
      {% csrf_token %}
      <button class="btn btn-primary" type="submit" name="action" value="generate_bible">Generate bible</button>
      <button class="btn btn-secondary" type="submit" name="action" value="generate_all_scenes">Generate all scenes</button>
    </form>

    <h2 class="h2">Quick stats</h2>
    <ul>
      <li>{{ project.characters.count }} characters</li>
      <li>{{ project.outline_nodes.count }} outline nodes</li>
      <li>{{ project.runs.count }} generation runs</li>
    </ul>
  </section>

  <section class="card">
    <details class="collapsible">
      <summary class="collapsible-summary">
        <span class="collapsible-title">Story bible</span>
        <span class="actions">
          <a class="btn btn-secondary btn-sm" href="{% url 'bible-edit' slug=project.slug %}">Edit bible</a>
          {% if bible %}
            <span class="muted">Updated {{ bible.updated_at }}</span>
          {% endif %}
        </span>
      </summary>

      {% if bible and bible.summary_md %}
        <p class="pre">{{ bible.summary_md }}</p>
      {% else %}
        <p class="muted">No story bible yet. Click "Generate bible".</p>
      {% endif %}
    </details>
  </section>

  {% comment %} <section class="card">
    <details class="collapsible">
      <summary class="collapsible-summary">
        <span class="collapsible-title">Recent runs</span>
        <span class="muted">{% if recent_runs %}{{ recent_runs|length }}{% else %}0{% endif %}</span>
      </summary>

      {% if recent_runs %}
        <ul class="list">
          {% for run in recent_runs %}
            <li class="list-item">
              <div>
                <div class="list-title">{{ run.run_type }} - {{ run.status }}</div>
                <div class="muted">{{ run.created_at }}</div>
              </div>
              {% if run.output_text %}
                <span class="muted">output</span>
              {% elif run.error %}
                <span class="muted">error</span>
              {% else %}
                <span class="muted">-</span>
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="muted">No runs yet.</p>
      {% endif %}
    </details>
  </section> {% endcomment %}

  <section
    class="card"
    data-scene-move-url="{% url 'scene-move' slug=project.slug %}"
    data-scene-rename-url="{% url 'scene-rename' slug=project.slug %}"
  >
    <div class="header-row">
      <h1>Outline</h1>
      <a class="btn btn-secondary" href="{% url 'project-edit' slug=project.slug %}">Edit project</a>
    </div>
    <p class="muted">Tip: drag scenes between chapters.</p>

    {% if outline_tree %}
      <ul>
        {% for item in outline_tree %}
          <li>
            <details class="collapsible">
              <summary class="collapsible-summary">
                <span class="collapsible-title">{{ item.act.title|default:"(Untitled act)" }}</span>
                <span class="actions">
                  <span class="muted">{% if item.chapters %}{{ item.chapters|length }} chapters{% else %}0 chapters{% endif %}</span>
                  <a class="btn btn-secondary btn-sm" href="{% url 'chapter-add' slug=project.slug act_id=item.act.id %}">Add chapter</a>
                </span>
              </summary>

              {% if item.chapters %}
                <ul>
                  {% for chapter_item in item.chapters %}
                    <li>
                      <hr class="outline-sep" />
                      <div class="outline-row">
                        <span>{{ chapter_item.chapter.title|default:"(Untitled chapter)" }}</span>
                        <div class="actions">
                          <a class="btn btn-secondary btn-sm" href="{% url 'scene-add' slug=project.slug chapter_id=chapter_item.chapter.id %}">Add scene</a>
                          <a class="btn btn-secondary btn-sm" href="{% url 'outline-node-edit' slug=project.slug pk=chapter_item.chapter.id %}">Edit</a>
                          <a class="btn btn-secondary btn-sm" href="{% url 'outline-node-delete' slug=project.slug pk=chapter_item.chapter.id %}">Delete</a>
                        </div>
                      </div>
                      {% if chapter_item.scenes %}
                        <ul class="scene-list" data-chapter-id="{{ chapter_item.chapter.id }}">
                          {% for scene in chapter_item.scenes %}
                            <li class="scene-item" data-scene-id="{{ scene.id }}" data-chapter-id="{{ chapter_item.chapter.id }}">
                              <div class="outline-row">
                                <span class="scene-left">
                                  <span class="scene-drag" draggable="true" title="Drag to move">Drag</span>
                                  <input
                                    class="scene-title-input"
                                    type="text"
                                    value="{{ scene.title }}"
                                    placeholder="(Untitled scene)"
                                    aria-label="Scene title"
                                  />
                                  {% if scene.pov or scene.location %}
                                    <span class="muted">
                                      {% if scene.pov %}POV: {{ scene.pov }}{% endif %}
                                      {% if scene.pov and scene.location %} / {% endif %}
                                      
                                    </span>
                                  {% endif %}
                                </span>
                                <div class="actions">
                                  <a class="btn btn-secondary btn-sm" href="{% url 'outline-node-edit' slug=project.slug pk=scene.id %}">Edit</a>
                                  <a class="btn btn-secondary btn-sm" href="{% url 'outline-node-delete' slug=project.slug pk=scene.id %}">Delete</a>
                                </div>
                              </div>
                            </li>
                          {% endfor %}
                        </ul>
                      {% else %}
                        <ul class="scene-list scene-list-empty" data-chapter-id="{{ chapter_item.chapter.id }}">
                          <li class="scene-dropzone" data-chapter-id="{{ chapter_item.chapter.id }}">
                            No scenes yet â€” drop a scene here
                          </li>
                        </ul>
                      {% endif %}
                    </li>
                  {% endfor %}
                </ul>
              {% else %}
                <div class="muted">No chapters yet.</div>
              {% endif %}
            </details>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="muted">No outline nodes yet.</p>
    {% endif %}
  </section>

  <script src="{% static 'main/outline_dragdrop.js' %}" defer></script>
  <script src="{% static 'main/outline_scene_title.js' %}" defer></script>
{% endblock %}
